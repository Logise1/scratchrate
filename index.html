<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch Trending Explorer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .project-card { transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .project-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.3); border-color: #f97316; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #f97316; border-radius: 4px; }
        .scratch-text { color: #f97316; }
        .loader { border: 4px solid #1e293b; border-top: 4px solid #f97316; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        /* Stars Interaction */
        .star-btn { cursor: pointer; transition: color 0.1s, transform 0.1s; font-size: 1.5rem; }
        .star-btn:hover { transform: scale(1.2); }
        
        /* View Transition */
        .view-section { display: none; opacity: 0; transition: opacity 0.3s ease-in-out; }
        .view-section.active { display: block; opacity: 1; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-50 shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3 cursor-pointer" onclick="navigateHome()">
                    <i class="fa-solid fa-cat text-3xl scratch-text"></i>
                    <h1 class="text-2xl font-bold tracking-tight hidden sm:block">Scratch <span class="scratch-text">Explorer</span></h1>
                </div>
                <!-- Search -->
                <div id="search-container" class="flex-grow max-w-lg w-full relative">
                    <form onsubmit="handleSearch(event)" class="flex gap-2">
                        <input type="text" id="search-input" placeholder="Search projects..." class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-slate-200 focus:outline-none focus:border-orange-500 transition">
                        <button type="submit" class="bg-slate-700 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition"><i class="fa-solid fa-magnifying-glass"></i></button>
                    </form>
                </div>
                <!-- Auth -->
                <div id="auth-section" class="flex items-center gap-4 min-w-fit">
                    <button id="btn-login" onclick="loginWithWorker()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded transition flex items-center gap-2 text-sm"><i class="fa-solid fa-right-to-bracket"></i> Login</button>
                    <div id="user-info" class="hidden flex items-center gap-3">
                        <span class="text-sm text-slate-300 hidden sm:inline">Hi, <span id="username-display" class="font-bold text-white">User</span></span>
                        <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300 underline">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- VIEWS CONTAINER -->
    <main class="flex-grow container mx-auto px-4 py-8 relative">
        
        <!-- 1. HOME VIEW (Grid) -->
        <div id="home-view" class="view-section active">
            <!-- Filters -->
            <div class="mb-6 flex gap-4 overflow-x-auto whitespace-nowrap custom-scrollbar pb-2">
                <span class="text-slate-400 text-sm font-bold uppercase self-center mr-2"><i class="fa-solid fa-arrow-down-short-wide mr-1"></i> Sort By:</span>
                <button onclick="sortGrid('default')" class="sort-btn px-3 py-1 rounded-full bg-slate-800 hover:bg-slate-700 text-xs text-slate-300 border border-slate-700 transition active-sort" id="sort-default">Trending</button>
                <button onclick="sortGrid('best')" class="sort-btn px-3 py-1 rounded-full bg-slate-800 hover:bg-green-900 text-xs text-green-400 border border-slate-700 transition" id="sort-best">Best Rated</button>
                <button onclick="sortGrid('worst')" class="sort-btn px-3 py-1 rounded-full bg-slate-800 hover:bg-red-900 text-xs text-red-400 border border-slate-700 transition" id="sort-worst">Worst Rated</button>
                <button onclick="sortGrid('most-voted')" class="sort-btn px-3 py-1 rounded-full bg-slate-800 hover:bg-blue-900 text-xs text-blue-400 border border-slate-700 transition" id="sort-most-voted">Most Voted</button>
            </div>

            <div id="loading" class="flex flex-col items-center justify-center py-20">
                <div class="loader mb-4"></div>
                <p class="text-slate-400 animate-pulse">Loading Projects...</p>
            </div>
            
            <div id="projects-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 hidden"></div>
            <p id="no-results" class="hidden text-center text-slate-500 mt-10">No projects found.</p>
        </div>

        <!-- 2. PROJECT VIEW (Details Page) -->
        <div id="project-view" class="view-section">
            <!-- Back Button -->
            <button onclick="navigateHome()" class="mb-4 text-slate-400 hover:text-white flex items-center gap-2 transition">
                <i class="fa-solid fa-arrow-left"></i> Back to Trending
            </button>

            <div class="flex flex-col lg:flex-row gap-8">
                
                <!-- Left Column: Game & Info -->
                <div class="w-full lg:w-2/3 flex flex-col gap-6">
                    <!-- Iframe -->
                    <div class="w-full aspect-video bg-black rounded-xl overflow-hidden shadow-2xl border border-slate-700 relative">
                        <iframe id="page-iframe" class="w-full h-full" src="" allowtransparency="true" allowfullscreen allow="autoplay; microphone; camera"></iframe>
                    </div>
                    
                    <!-- Header Info -->
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <div class="flex justify-between items-start">
                            <div>
                                <h1 id="page-title" class="text-3xl font-bold text-white mb-2">Project Title</h1>
                                <p class="text-slate-400">Created by <span id="page-author" class="text-orange-400 font-bold cursor-pointer">User</span></p>
                            </div>
                            <div class="text-right">
                                <span class="text-xs bg-slate-700 px-2 py-1 rounded text-slate-400 font-mono" id="page-id">ID: 000</span>
                            </div>
                        </div>
                        
                        <!-- Description -->
                        <div class="mt-6 p-4 bg-slate-900/50 rounded-lg border border-slate-700/50">
                            <h3 class="text-xs font-bold text-slate-500 uppercase mb-2">Instructions & Notes</h3>
                            <p id="page-desc" class="text-sm text-slate-300 whitespace-pre-wrap leading-relaxed">...</p>
                        </div>
                    </div>

                    <!-- Reviews List -->
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <h2 class="text-xl font-bold text-white mb-4 flex items-center gap-2">
                            <i class="fa-solid fa-comments text-slate-400"></i> Reviews
                        </h2>
                        <div id="reviews-list" class="flex flex-col gap-4">
                            <!-- Reviews injected here -->
                            <p class="text-slate-500 italic">No reviews yet. Be the first!</p>
                        </div>
                    </div>
                </div>

                <!-- Right Column: Stats & Voting -->
                <div class="w-full lg:w-1/3 flex flex-col gap-6">
                    
                    <!-- Score Card -->
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700 shadow-lg relative overflow-hidden">
                        <div class="absolute top-0 right-0 p-4 opacity-5"><i class="fa-solid fa-star text-8xl"></i></div>
                        <h3 class="text-sm font-uppercase text-slate-400 font-bold mb-4 tracking-wider">COMMUNITY SCORE</h3>
                        
                        <div class="flex items-center gap-6">
                            <div class="relative w-24 h-24 flex items-center justify-center">
                                <svg class="transform -rotate-90 w-24 h-24"><circle cx="48" cy="48" r="40" stroke="#334155" stroke-width="8" fill="transparent" /><circle id="page-circle" cx="48" cy="48" r="40" stroke="#fbbf24" stroke-width="8" fill="transparent" stroke-dasharray="251" stroke-dashoffset="251" /></svg>
                                <span id="page-rating-text" class="absolute text-2xl font-bold text-white">?</span>
                            </div>
                            <div>
                                <div class="text-4xl font-bold text-white mb-1" id="page-score-display">--</div>
                                <div class="text-sm text-slate-400"><span id="page-vote-count" class="font-bold text-white">0</span> votes</div>
                            </div>
                        </div>

                        <!-- Stats Grid -->
                        <div class="grid grid-cols-2 gap-4 mt-6 pt-6 border-t border-slate-700">
                            <div class="text-center bg-slate-900/50 p-2 rounded">
                                <i class="fa-regular fa-eye text-blue-400"></i>
                                <div class="font-bold text-white" id="page-views">0</div>
                                <div class="text-[10px] text-slate-500 uppercase">Views</div>
                            </div>
                            <div class="text-center bg-slate-900/50 p-2 rounded">
                                <i class="fa-regular fa-heart text-pink-500"></i>
                                <div class="font-bold text-white" id="page-loves">0</div>
                                <div class="text-[10px] text-slate-500 uppercase">Loves</div>
                            </div>
                        </div>
                    </div>

                    <!-- Voting Panel -->
                    <div class="bg-slate-800 p-6 rounded-xl border border-slate-700">
                        <h3 class="text-sm font-uppercase text-slate-400 font-bold mb-4 tracking-wider">WRITE A REVIEW</h3>
                        
                        <div id="vote-area" class="opacity-50 pointer-events-none transition-opacity">
                            <!-- Stars -->
                            <div class="flex justify-between mb-2 px-1">
                                <span class="text-[10px] text-slate-500 font-bold">WORST</span>
                                <span class="text-[10px] text-slate-500 font-bold">BEST</span>
                            </div>
                            <div class="grid grid-cols-10 gap-1 mb-4" id="stars-container"></div>
                            <p id="vote-msg" class="text-center text-sm font-bold text-slate-300 mb-4 h-5">Select a rating</p>
                            
                            <!-- Comment Input -->
                            <textarea id="review-comment" class="w-full bg-slate-900 border border-slate-700 rounded-lg p-3 text-sm text-white placeholder-slate-600 focus:border-orange-500 focus:outline-none transition mb-3" rows="3" placeholder="Write your opinion here (optional)..."></textarea>
                            
                            <!-- Submit Button -->
                            <button onclick="submitReview()" class="w-full bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 rounded-lg transition">
                                Post Review
                            </button>
                        </div>
                        
                        <div id="login-warning" class="bg-slate-900/50 p-4 rounded-lg text-center border border-slate-700">
                            <p class="text-orange-400 text-sm mb-2">Login with Scratch to review</p>
                            <button onclick="loginWithWorker()" class="text-xs underline text-slate-400 hover:text-white">Login now</button>
                        </div>
                    </div>

                </div>
            </div>
        </div>

    </main>

    <script>
        // --- CONFIGURATION ---
        const WORKER_URL = "https://scratchrate.logise1123.workers.dev"; // CHANGE THIS
        const PROXY = "https://api.allorigins.win/raw?url=";
        const API_TRENDING = "https://api.scratch.mit.edu/explore/projects?limit=40&mode=trending&q=*";
        const API_SEARCH_BASE = "https://api.scratch.mit.edu/explore/projects?limit=40&mode=popular&q=";

        // --- STATE ---
        let currentProject = null;
        let sessionToken = null;
        let currentUser = null;
        let projectsData = [];
        let projectsStatsCache = {}; // { id: { average, count, reviews: [] } }
        let currentRating = 0; // Temporary storage for voting

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            generateStarsUI();
            checkAuth();
            handleRouting(); // Check URL hash on load
            
            // If home, fetch initial
            if(!location.hash.startsWith('#project-')) fetchProjects();
        });

        window.addEventListener('hashchange', handleRouting);

        // --- ROUTING (SPA) ---
        function handleRouting() {
            const hash = location.hash;
            if (hash.startsWith('#project-')) {
                const id = hash.replace('#project-', '');
                showProjectPage(id);
            } else {
                showHomePage();
            }
        }

        function navigateHome() {
            window.location.hash = ""; // Triggers handleRouting -> showHomePage
        }

        function showHomePage() {
            document.getElementById('home-view').classList.add('active');
            document.getElementById('project-view').classList.remove('active');
            document.getElementById('search-container').classList.remove('hidden');
            
            // Stop iframe to stop audio
            document.getElementById('page-iframe').src = "";
            
            if(projectsData.length === 0) fetchProjects();
        }

        async function showProjectPage(id) {
            document.getElementById('home-view').classList.remove('active');
            document.getElementById('project-view').classList.add('active');
            document.getElementById('search-container').classList.add('hidden'); // Clean header
            
            // Find project data (from cache or fetch if direct link)
            let p = projectsData.find(x => x.id == id);
            
            // If direct access or not found in trending, fetch individual
            if (!p) {
                try {
                    const res = await fetch(`${WORKER_URL}/proxy?url=${encodeURIComponent(`https://api.scratch.mit.edu/projects/${id}`)}`);
                    if(!res.ok) throw new Error("Not found");
                    p = await res.json();
                    // Normalize data structure if needed (Scratch API individual vs grid differs slightly)
                    if(!p.author) p.author = { username: p.username || "Unknown" }; // Polyfill
                } catch(e) {
                    alert("Project not found or API error.");
                    navigateHome();
                    return;
                }
            }
            
            currentProject = p;
            renderProjectDetails(p);
        }

        // --- RENDER PROJECT ---
        function renderProjectDetails(p) {
            // Basic Info
            document.getElementById('page-title').textContent = p.title;
            document.getElementById('page-author').textContent = p.author.username;
            document.getElementById('page-id').textContent = `ID: ${p.id}`;
            document.getElementById('page-desc').textContent = (p.instructions||"") + "\n\n" + (p.description||"");
            document.getElementById('page-iframe').src = `https://scratch.mit.edu/projects/${p.id}/embed`;
            document.getElementById('page-views').textContent = formatNum(p.stats.views);
            document.getElementById('page-loves').textContent = formatNum(p.stats.loves);

            // Reset Rating UI
            updatePageRating(0, 0, true);
            resetStars();
            document.getElementById('review-comment').value = "";
            document.getElementById('reviews-list').innerHTML = '<div class="loader mx-auto"></div>';

            // Fetch Real Stats & Reviews
            fetchProjectStatsAndReviews(p.id);
        }

        async function fetchProjectStatsAndReviews(id) {
            try {
                const res = await fetch(`${WORKER_URL}/stats?id=${id}`);
                const data = await res.json(); // { average, count, reviews: [...] }
                
                projectsStatsCache[id] = data; // Update cache
                updatePageRating(Number(data.average), Number(data.count));
                renderReviews(data.reviews || []);
            } catch(e) {
                console.error(e);
                document.getElementById('reviews-list').innerHTML = '<p class="text-red-400">Error loading reviews.</p>';
            }
        }

        function renderReviews(reviews) {
            const list = document.getElementById('reviews-list');
            list.innerHTML = '';
            
            if (reviews.length === 0) {
                list.innerHTML = '<p class="text-slate-500 italic text-center py-4">No reviews yet. Be the first!</p>';
                return;
            }

            reviews.forEach(r => {
                // Color for rating badge
                let colorClass = r.rating >= 8 ? 'bg-green-900 text-green-300 border-green-700' : (r.rating >= 5 ? 'bg-yellow-900 text-yellow-300 border-yellow-700' : 'bg-red-900 text-red-300 border-red-700');
                
                const item = document.createElement('div');
                item.className = "bg-slate-900 p-4 rounded-lg border border-slate-700 flex flex-col gap-2";
                item.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-2">
                            <span class="font-bold text-white">${r.username}</span>
                            <span class="text-xs text-slate-500">${new Date(r.timestamp).toLocaleDateString()}</span>
                        </div>
                        <div class="${colorClass} px-2 py-0.5 rounded text-xs font-bold border flex items-center gap-1">
                            <i class="fa-solid fa-star text-[10px]"></i> ${r.rating}
                        </div>
                    </div>
                    ${r.comment ? `<p class="text-slate-300 text-sm mt-1">${escapeHtml(r.comment)}</p>` : ''}
                `;
                list.appendChild(item);
            });
        }

        function updatePageRating(avg, count, reset=false) {
            const circle = document.getElementById('page-circle');
            const scoreDisplay = document.getElementById('page-score-display');
            const ratingText = document.getElementById('page-rating-text');
            document.getElementById('page-vote-count').textContent = count;

            if(reset) {
                circle.style.strokeDashoffset = 251; // 251 is circ of r=40
                scoreDisplay.textContent = "--";
                ratingText.textContent = "?";
                return;
            }

            scoreDisplay.textContent = avg.toFixed(1) + " / 10";
            ratingText.textContent = avg.toFixed(1);
            
            const pct = (avg / 10) * 100;
            const offset = 251 - (251 * pct) / 100;
            circle.style.strokeDashoffset = offset;
            
            if(avg >= 8) circle.setAttribute('stroke', '#4ade80');
            else if(avg >= 5) circle.setAttribute('stroke', '#facc15');
            else circle.setAttribute('stroke', '#f87171');
        }

        // --- VOTING SYSTEM ---
        function generateStarsUI() {
            const c = document.getElementById('stars-container');
            c.innerHTML = '';
            for(let i=1; i<=10; i++) {
                const b = document.createElement('i');
                b.className = `star-btn fa-solid fa-star text-slate-700 text-xl flex justify-center`;
                b.id = `s${i}`;
                b.onclick = () => { currentRating = i; highlightStars(i); document.getElementById('vote-msg').textContent = `Rating: ${i}/10`; };
                b.onmouseover = () => { highlightStars(i); document.getElementById('vote-msg').textContent = `${i}/10`; };
                b.onmouseout = () => { if(currentRating===0) resetStars(); else highlightStars(currentRating); };
                c.appendChild(b);
            }
        }

        function highlightStars(num) {
            for(let j=1; j<=10; j++) {
                const s = document.getElementById(`s${j}`);
                s.classList.remove('text-slate-700', 'text-yellow-400', 'text-green-400', 'text-red-400');
                if (j <= num) {
                    if (num <= 4) s.classList.add('text-red-400');
                    else if (num <= 7) s.classList.add('text-yellow-400');
                    else s.classList.add('text-green-400');
                } else {
                    s.classList.add('text-slate-700');
                }
            }
        }

        function resetStars() {
            document.getElementById('vote-msg').textContent = "Select rating";
            for(let j=1; j<=10; j++) document.getElementById(`s${j}`).className = `star-btn fa-solid fa-star text-slate-700 text-xl flex justify-center`;
        }

        async function submitReview() {
            if (!sessionToken) return alert("Login required");
            if (currentRating === 0) return alert("Please select a star rating first.");
            
            const comment = document.getElementById('review-comment').value.trim();
            const btn = document.querySelector('#vote-area button');
            const originalText = btn.textContent;
            
            btn.disabled = true;
            btn.textContent = "Posting...";

            try {
                const res = await fetch(`${WORKER_URL}/vote`, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ 
                        sessionToken, 
                        projectId: currentProject.id, 
                        rating: currentRating,
                        comment: comment 
                    })
                });

                if(res.ok) {
                    // Reload details to show new review
                    fetchProjectStatsAndReviews(currentProject.id);
                    // Also update grid cache
                    fetchCardStats(currentProject.id);
                    
                    document.getElementById('review-comment').value = ""; // Clear
                    btn.textContent = "Review Posted!";
                    setTimeout(() => {
                        btn.disabled = false;
                        btn.textContent = "Post Review";
                    }, 2000);
                } else {
                    throw new Error("Failed");
                }
            } catch(e) {
                console.error(e);
                alert("Error posting review. Try again.");
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // --- GRID & FETCHING (Original Logic Adapted) ---
        async function fetchWithProxy(targetUrl) {
            const proxyUrl = `${WORKER_URL}/proxy?url=${encodeURIComponent(targetUrl)}`;
            const res = await fetch(proxyUrl);
            if (!res.ok) throw new Error("Proxy error");
            return res.json();
        }

        function handleSearch(e) {
            e.preventDefault();
            const query = document.getElementById('search-input').value.trim();
            if(!query) return;
            navigateHome();
            toggleLoading(true);
            fetchProjects(API_SEARCH_BASE + encodeURIComponent(query));
        }

        async function fetchProjects(url = API_TRENDING) {
            try {
                const data = await fetchWithProxy(url);
                if(!data || data.length === 0) {
                    toggleLoading(false, true);
                    projectsData = [];
                    return;
                }
                projectsData = data;
                
                // Batch stats
                const ids = data.map(p => p.id);
                fetchBatchStats(ids);

                renderGrid(projectsData);
                toggleLoading(false);
            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerHTML = "<p class='text-red-400'>Error loading Scratch API.</p>";
            }
        }

        async function fetchBatchStats(ids) {
            try {
                const res = await fetch(`${WORKER_URL}/stats-batch`, { method: 'POST', body: JSON.stringify({ ids }) });
                if(res.ok) {
                    const batchData = await res.json();
                    Object.assign(projectsStatsCache, batchData);
                    renderGrid(projectsData); // Re-render to show badges
                }
            } catch(e) {}
        }

        async function fetchCardStats(id) {
             // For single card update
             try {
                const res = await fetch(`${WORKER_URL}/stats?id=${id}`);
                const data = await res.json();
                projectsStatsCache[id] = data;
                // Ideally update just that DOM element, but re-render is safe here
             } catch(e) {}
        }

        function renderGrid(projects) {
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = '';
            projects.forEach(p => {
                const card = document.createElement('div');
                card.className = "project-card bg-slate-800 rounded-lg overflow-hidden border border-slate-700 relative flex flex-col";
                card.onclick = () => window.location.hash = `project-${p.id}`; // NAVIGATE
                const img = `https://cdn2.scratch.mit.edu/get_image/project/${p.id}_480x360.png`;
                
                // Badge Logic
                const stats = projectsStatsCache[p.id] || { count: 0, average: 0 };
                let badgeHtml = '';
                if(stats.count >= 5) {
                    let color = stats.average >= 8 ? 'text-green-400' : (stats.average >= 5 ? 'text-yellow-400' : 'text-red-400');
                    let border = stats.average >= 8 ? 'border-green-500' : (stats.average >= 5 ? 'border-yellow-500' : 'border-red-500');
                    badgeHtml = `<div class="absolute top-2 left-2 bg-black/80 px-2 py-0.5 rounded text-xs font-bold flex items-center gap-1 backdrop-blur-sm border ${border} ${color}">
                        <i class="fa-solid fa-star text-[10px]"></i><span>${Number(stats.average).toFixed(1)}</span></div>`;
                }

                card.innerHTML = `
                    <div class="relative w-full aspect-[4/3] bg-black">
                        <img src="${img}" class="w-full h-full object-cover" loading="lazy">
                        <div class="absolute bottom-2 right-2 bg-black/60 px-2 rounded text-xs text-white backdrop-blur-sm"><i class="fa-solid fa-eye"></i> ${formatNum(p.stats.views)}</div>
                        ${badgeHtml}
                    </div>
                    <div class="p-3 flex-grow">
                        <h3 class="font-bold text-white truncate text-sm mb-1">${p.title}</h3>
                        <p class="text-xs text-slate-400">by ${p.author.username}</p>
                    </div>`;
                grid.appendChild(card);
            });
        }

        function sortGrid(mode) {
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.replace('bg-slate-600', 'bg-slate-800'));
            document.getElementById(`sort-${mode}`).classList.replace('bg-slate-800', 'bg-slate-600');
            let sorted = [...projectsData];
            if (mode !== 'default') {
                sorted = sorted.filter(p => (projectsStatsCache[p.id]?.count || 0) > 0);
                if (mode === 'best') sorted.sort((a, b) => (projectsStatsCache[b.id]?.average || 0) - (projectsStatsCache[a.id]?.average || 0));
                else if (mode === 'worst') sorted.sort((a, b) => (projectsStatsCache[a.id]?.average || 0) - (projectsStatsCache[b.id]?.average || 0));
                else if (mode === 'most-voted') sorted.sort((a, b) => (projectsStatsCache[b.id]?.count || 0) - (projectsStatsCache[a.id]?.count || 0));
            }
            renderGrid(sorted);
        }

        // --- AUTH & UTILS ---
        function checkAuth() {
            const p = new URLSearchParams(location.search);
            if(p.get('token')) {
                localStorage.setItem('s_tok', p.get('token'));
                localStorage.setItem('s_usr', p.get('username'));
                history.replaceState({},'', '/');
            }
            sessionToken = localStorage.getItem('s_tok');
            currentUser = localStorage.getItem('s_usr');
            if(sessionToken) {
                document.getElementById('btn-login').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('username-display').textContent = currentUser;
                document.getElementById('vote-area').classList.remove('opacity-50', 'pointer-events-none');
                document.getElementById('login-warning').classList.add('hidden');
            }
        }
        function loginWithWorker() { location.href = `${WORKER_URL}/auth/login`; }
        function logout() { localStorage.clear(); location.reload(); }
        
        function toggleLoading(show, empty=false) {
            const l = document.getElementById('loading');
            const g = document.getElementById('projects-grid');
            const n = document.getElementById('no-results');
            if(show) { l.classList.remove('hidden'); g.classList.add('hidden'); n.classList.add('hidden'); }
            else { l.classList.add('hidden'); g.classList.toggle('hidden', empty); n.classList.toggle('hidden', !empty); }
        }
        function formatNum(n) { return new Intl.NumberFormat('en-US', {notation:"compact"}).format(n); }
        function escapeHtml(text) { return text.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;").replace(/'/g, "&#039;"); }
    </script>
</body>
</html>
