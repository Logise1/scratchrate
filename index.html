<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch Trending Explorer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .project-card { transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .project-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.3); border-color: #f97316; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #f97316; border-radius: 4px; }
        .scratch-text { color: #f97316; }
        .loader { border: 4px solid #1e293b; border-top: 4px solid #f97316; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .star-btn { cursor: pointer; transition: color 0.1s, transform 0.1s; font-size: 1.25rem; }
        .star-btn:hover { transform: scale(1.2); }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-40 shadow-lg">
        <div class="container mx-auto px-4 py-4">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <div class="flex items-center gap-3">
                    <i class="fa-solid fa-cat text-3xl scratch-text"></i>
                    <h1 class="text-2xl font-bold tracking-tight hidden sm:block">Scratch <span class="scratch-text">Explorer</span></h1>
                </div>
                <!-- Search Bar -->
                <div class="flex-grow max-w-lg w-full relative">
                    <form onsubmit="handleSearch(event)" class="flex gap-2">
                        <input type="text" id="search-input" placeholder="Search projects..." class="w-full bg-slate-900 border border-slate-700 rounded-lg px-4 py-2 text-slate-200 focus:outline-none focus:border-orange-500 transition">
                        <button type="submit" class="bg-slate-700 hover:bg-orange-600 text-white px-4 py-2 rounded-lg transition"><i class="fa-solid fa-magnifying-glass"></i></button>
                    </form>
                </div>
                <!-- Auth -->
                <div id="auth-section" class="flex items-center gap-4 min-w-fit">
                    <button id="btn-login" onclick="loginWithWorker()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded transition flex items-center gap-2 text-sm"><i class="fa-solid fa-right-to-bracket"></i> Login</button>
                    <div id="user-info" class="hidden flex items-center gap-3">
                        <span class="text-sm text-slate-300 hidden sm:inline">Hi, <span id="username-display" class="font-bold text-white">User</span></span>
                        <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300 underline">Logout</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- Filters -->
    <div class="bg-slate-900 border-b border-slate-800 py-3">
        <div class="container mx-auto px-4 flex gap-4 overflow-x-auto whitespace-nowrap custom-scrollbar">
            <span class="text-slate-400 text-sm font-bold uppercase self-center mr-2"><i class="fa-solid fa-arrow-down-short-wide mr-1"></i> Sort By:</span>
            <button onclick="sortGrid('default')" class="sort-btn px-3 py-1 rounded-full bg-slate-800 hover:bg-slate-700 text-xs text-slate-300 border border-slate-700 transition active-sort" id="sort-default">Trending</button>
            <button onclick="sortGrid('best')" class="sort-btn px-3 py-1 rounded-full bg-slate-800 hover:bg-green-900 text-xs text-green-400 border border-slate-700 transition" id="sort-best">Best Rated</button>
            <button onclick="sortGrid('worst')" class="sort-btn px-3 py-1 rounded-full bg-slate-800 hover:bg-red-900 text-xs text-red-400 border border-slate-700 transition" id="sort-worst">Worst Rated</button>
            <button onclick="sortGrid('most-voted')" class="sort-btn px-3 py-1 rounded-full bg-slate-800 hover:bg-blue-900 text-xs text-blue-400 border border-slate-700 transition" id="sort-most-voted">Most Voted</button>
        </div>
    </div>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <p class="text-slate-400 animate-pulse">Loading Projects from Scratch via Worker...</p>
        </div>
        <div id="projects-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 hidden"></div>
        <p id="no-results" class="hidden text-center text-slate-500 mt-10">No projects found.</p>
    </main>

    <!-- Modal -->
    <div id="project-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm">
        <div class="bg-slate-900 rounded-xl shadow-2xl w-full max-w-6xl max-h-[95vh] overflow-hidden flex flex-col border border-slate-700">
            <div class="flex justify-between items-center p-4 border-b border-slate-800 bg-slate-900">
                <h2 class="text-lg font-semibold text-slate-300 truncate pr-4" id="modal-title-top">Viewer</h2>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>
            <div class="flex-grow overflow-y-auto p-0 lg:p-6">
                <div class="flex flex-col lg:flex-row gap-6">
                    <div class="w-full lg:w-2/3 flex flex-col gap-4">
                        <div class="w-full aspect-video bg-black rounded-lg overflow-hidden shadow-lg border border-slate-800 relative">
                            <iframe id="modal-iframe" class="w-full h-full" src="" allowtransparency="true" allowfullscreen></iframe>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                            <h1 id="modal-title" class="text-3xl font-bold text-white mb-1">...</h1>
                            <p class="text-slate-400">by <span id="modal-author" class="text-orange-400 font-bold">...</span></p>
                        </div>
                    </div>
                    <div class="w-full lg:w-1/3 flex flex-col gap-4">
                        <div class="bg-slate-800 p-5 rounded-lg border border-slate-700 shadow-lg relative overflow-hidden">
                            <h3 class="text-sm font-uppercase text-slate-400 font-bold mb-3 tracking-wider">SCORE</h3>
                            <div class="flex items-center gap-4 mb-4">
                                <div class="relative w-20 h-20 flex items-center justify-center">
                                    <svg class="transform -rotate-90 w-20 h-20"><circle cx="40" cy="40" r="36" stroke="#334155" stroke-width="8" fill="transparent" /><circle id="enjoyment-circle" cx="40" cy="40" r="36" stroke="#fbbf24" stroke-width="8" fill="transparent" stroke-dasharray="226" stroke-dashoffset="226" /></svg>
                                    <span id="rating-text" class="absolute text-xl font-bold text-white">?</span>
                                </div>
                                <div>
                                    <div class="text-2xl font-bold text-white mb-1" id="score-display">???</div>
                                    <div class="text-xs text-slate-500"><span id="vote-count" class="text-slate-300 font-bold">0</span> votes</div>
                                </div>
                            </div>
                        </div>
                        <div class="bg-slate-800 p-5 rounded-lg border border-slate-700">
                            <h3 class="text-sm font-uppercase text-slate-400 font-bold mb-3 tracking-wider">YOUR VOTE (1-10)</h3>
                            <div id="vote-area" class="opacity-50 pointer-events-none transition-opacity">
                                <div class="grid grid-cols-10 gap-0.5 mb-2" id="stars-container"></div>
                                <div class="flex justify-between text-[10px] text-slate-500 uppercase font-bold px-1"><span>Worst</span><span>Best</span></div>
                                <p id="vote-msg" class="text-center text-xs text-slate-400 mt-2 h-4">Select rating</p>
                            </div>
                            <p id="login-warning" class="text-center text-xs text-orange-400 mt-3">Please login to vote.</p>
                        </div>
                        <div class="bg-slate-800 p-5 rounded-lg border border-slate-700 flex-grow">
                            <h3 class="text-sm font-uppercase text-slate-400 font-bold mb-2">Info</h3>
                            <div class="overflow-y-auto max-h-40 custom-scrollbar pr-2"><p id="modal-desc" class="text-sm text-slate-300 whitespace-pre-wrap">...</p></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // CONFIG
        const WORKER_URL = "https://scratchrate.logise1123.workers.dev"; // PON TU URL AQUI
        const API_TRENDING = "https://api.scratch.mit.edu/explore/projects?limit=40&mode=trending&q=*";
        const API_SEARCH_BASE = "https://api.scratch.mit.edu/explore/projects?limit=40&mode=popular&q="; 

        let currentProject = null, sessionToken = null, currentUser = null;
        let projectsData = [], projectsStatsCache = {};

        window.addEventListener('DOMContentLoaded', () => {
            generateStarsUI();
            checkAuth();
            fetchProjects();
        });

        // 1. PROXY REQUEST
        async function fetchWithProxy(targetUrl) {
            const proxyUrl = `${WORKER_URL}/proxy?url=${encodeURIComponent(targetUrl)}`;
            const res = await fetch(proxyUrl);
            if (!res.ok) throw new Error("Proxy error");
            return res.json();
        }

        // 2. SEARCH & FETCH
        function handleSearch(e) {
            e.preventDefault();
            const query = document.getElementById('search-input').value.trim();
            if(!query) return;
            toggleLoading(true);
            fetchProjects(API_SEARCH_BASE + encodeURIComponent(query));
        }

        async function fetchProjects(url = API_TRENDING) {
            try {
                const data = await fetchWithProxy(url);
                if(!data || data.length === 0) {
                    toggleLoading(false, true);
                    projectsData = [];
                    return;
                }
                projectsData = data;
                projectsStatsCache = {}; // Clear cache
                
                // BATCH FETCH STATS
                const ids = data.map(p => p.id);
                await fetchBatchStats(ids);

                renderGrid(projectsData);
                toggleLoading(false);
            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerHTML = "<p class='text-red-400'>Error loading Scratch API via Worker Proxy.</p>";
            }
        }

        async function fetchBatchStats(ids) {
            try {
                const res = await fetch(`${WORKER_URL}/stats-batch`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ids })
                });
                if(res.ok) {
                    const batchData = await res.json();
                    Object.assign(projectsStatsCache, batchData);
                }
            } catch(e) { console.error("Batch stats failed", e); }
        }

        function renderGrid(projects) {
            const grid = document.getElementById('projects-grid');
            grid.innerHTML = '';
            projects.forEach(p => {
                const card = document.createElement('div');
                card.className = "project-card bg-slate-800 rounded-lg overflow-hidden border border-slate-700 relative flex flex-col";
                card.onclick = () => openModal(p);
                const img = `https://cdn2.scratch.mit.edu/get_image/project/${p.id}_480x360.png`;
                
                // Badge removed from thumbnails as requested

                card.innerHTML = `
                    <div class="relative w-full aspect-[4/3] bg-black">
                        <img src="${img}" class="w-full h-full object-cover" loading="lazy">
                        <div class="absolute bottom-2 right-2 bg-black/60 px-2 rounded text-xs text-white backdrop-blur-sm"><i class="fa-solid fa-eye"></i> ${formatNum(p.stats.views)}</div>
                    </div>
                    <div class="p-3 flex-grow">
                        <h3 class="font-bold text-white truncate text-sm mb-1">${p.title}</h3>
                        <p class="text-xs text-slate-400">by ${p.author.username}</p>
                    </div>`;
                grid.appendChild(card);
            });
        }

        // 3. SORTING & FILTERING (Hidden if no stats)
        function sortGrid(mode) {
            document.querySelectorAll('.sort-btn').forEach(b => b.classList.replace('bg-slate-600', 'bg-slate-800'));
            document.getElementById(`sort-${mode}`).classList.replace('bg-slate-800', 'bg-slate-600');

            let sorted = [...projectsData];

            if (mode !== 'default') {
                // FILTER: Only show projects with votes
                sorted = sorted.filter(p => {
                    const s = projectsStatsCache[p.id];
                    return s && s.count > 0;
                });

                if (mode === 'best') sorted.sort((a, b) => (projectsStatsCache[b.id]?.average || 0) - (projectsStatsCache[a.id]?.average || 0));
                else if (mode === 'worst') sorted.sort((a, b) => (projectsStatsCache[a.id]?.average || 0) - (projectsStatsCache[b.id]?.average || 0));
                else if (mode === 'most-voted') sorted.sort((a, b) => (projectsStatsCache[b.id]?.count || 0) - (projectsStatsCache[a.id]?.count || 0));
            }
            renderGrid(sorted);
        }

        // 4. MODAL & VOTING
        function openModal(p) {
            currentProject = p;
            document.getElementById('project-modal').classList.remove('hidden');
            
            // Info
            document.getElementById('modal-title').textContent = p.title;
            document.getElementById('modal-title-top').textContent = p.title;
            document.getElementById('modal-author').textContent = p.author.username;
            document.getElementById('modal-desc').textContent = (p.instructions||"") + "\n\n" + (p.description||"");
            document.getElementById('modal-iframe').src = `https://scratch.mit.edu/projects/${p.id}/embed`;

            // Reset & Load Stats
            updateRatingDisplay(0, 0, true);
            resetStars();
            
            // If cached, show immediately
            if(projectsStatsCache[p.id]) {
                const c = projectsStatsCache[p.id];
                updateRatingDisplay(c.average, c.count);
            } else {
                // Fetch individual if missing (rare with batch)
                fetch(`${WORKER_URL}/stats?id=${p.id}`).then(r=>r.json()).then(d => {
                    updateRatingDisplay(Number(d.average), Number(d.count));
                });
            }
        }

        function updateRatingDisplay(avg, count, reset) {
            const circle = document.getElementById('enjoyment-circle');
            const scoreDisplay = document.getElementById('score-display');
            const ratingText = document.getElementById('rating-text');
            
            document.getElementById('vote-count').textContent = count;
            
            if(reset) {
                circle.style.strokeDashoffset = 226;
                scoreDisplay.textContent = "...";
                ratingText.textContent = "?";
                return;
            }

            // Always show score now (no hidden threshold)
            scoreDisplay.textContent = avg.toFixed(1) + " / 10";
            ratingText.textContent = avg.toFixed(1);
            
            const pct = (avg / 10) * 100;
            circle.style.strokeDashoffset = 226 - (226 * pct) / 100;
            
            if(avg >= 8) circle.setAttribute('stroke', '#4ade80');
            else if(avg >= 5) circle.setAttribute('stroke', '#facc15');
            else circle.setAttribute('stroke', '#f87171');
        }

        async function rateProject(rating) {
            if (!sessionToken) return alert("Login required");
            document.getElementById('vote-msg').textContent = "Saving...";
            
            try {
                const res = await fetch(`${WORKER_URL}/vote`, {
                    method: 'POST', 
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ sessionToken, projectId: currentProject.id, rating })
                });
                if(res.ok) {
                    document.getElementById('vote-msg').textContent = "Saved!";
                    document.getElementById('vote-msg').classList.add('text-green-400');
                    // Refresh stats
                    const r = await fetch(`${WORKER_URL}/stats?id=${currentProject.id}`);
                    const d = await r.json();
                    projectsStatsCache[currentProject.id] = { average: Number(d.average), count: Number(d.count) };
                    updateRatingDisplay(Number(d.average), Number(d.count));
                }
            } catch(e) { console.error(e); }
        }

        // UTILS
        function generateStarsUI() {
            const c = document.getElementById('stars-container');
            c.innerHTML = '';
            for(let i=1; i<=10; i++) {
                const b = document.createElement('i');
                b.className = `star-btn fa-solid fa-star text-slate-700`;
                b.id = `s${i}`;
                b.onclick = () => rateProject(i);
                b.onmouseover = () => {
                    document.getElementById('vote-msg').textContent = `${i}/10`;
                    for(let j=1; j<=10; j++) document.getElementById(`s${j}`).classList.toggle('text-yellow-400', j<=i);
                };
                b.onmouseout = resetStars;
                c.appendChild(b);
            }
        }
        function resetStars() {
            document.getElementById('vote-msg').textContent = "Select rating";
            document.getElementById('vote-msg').classList.remove('text-green-400');
            for(let i=1; i<=10; i++) document.getElementById(`s${i}`).classList.remove('text-yellow-400', 'text-slate-700');
            for(let i=1; i<=10; i++) document.getElementById(`s${i}`).classList.add('text-slate-700');
        }

        function toggleLoading(show, empty=false) {
            const l = document.getElementById('loading');
            const g = document.getElementById('projects-grid');
            const n = document.getElementById('no-results');
            if(show) { l.classList.remove('hidden'); g.classList.add('hidden'); n.classList.add('hidden'); }
            else { l.classList.add('hidden'); g.classList.toggle('hidden', empty); n.classList.toggle('hidden', !empty); }
        }

        // Auth & Misc
        function checkAuth() {
            const p = new URLSearchParams(location.search);
            if(p.get('token')) {
                localStorage.setItem('s_tok', p.get('token'));
                localStorage.setItem('s_usr', p.get('username'));
                history.replaceState({},'', '/');
            }
            sessionToken = localStorage.getItem('s_tok');
            currentUser = localStorage.getItem('s_usr');
            if(sessionToken) {
                document.getElementById('btn-login').classList.add('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('username-display').textContent = currentUser;
                document.getElementById('vote-area').classList.remove('opacity-50', 'pointer-events-none');
                document.getElementById('login-warning').classList.add('hidden');
            }
        }
        function loginWithWorker() { location.href = `${WORKER_URL}/auth/login`; }
        function logout() { localStorage.clear(); location.reload(); }
        function closeModal() { document.getElementById('project-modal').classList.add('hidden'); document.getElementById('modal-iframe').src=""; }
        function formatNum(n) { return new Intl.NumberFormat('en-US', {notation:"compact"}).format(n); }
    </script>
</body>
</html>
