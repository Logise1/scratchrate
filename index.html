<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch Rate</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        
        .view-section { display: none; opacity: 0; transition: opacity 0.4s ease-in-out; }
        .view-section.active { display: block; opacity: 1; }

        .project-card { transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        .project-card:hover { transform: translateY(-8px) scale(1.02); box-shadow: 0 20px 25px -5px rgba(249, 115, 22, 0.3); border-color: #f97316; z-index: 10; }
        
        .creator-card { transition: all 0.3s; }
        .creator-card:hover { transform: translateY(-3px); background-color: rgba(30, 41, 59, 0.9); border-color: #f97316; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background: #0f172a; }
        ::-webkit-scrollbar-thumb { background: #334155; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #f97316; }
        
        .scratch-text { color: #f97316; }
        .loader { border: 4px solid #1e293b; border-top: 4px solid #f97316; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .star-btn { cursor: pointer; transition: transform 0.2s cubic-bezier(0.34, 1.56, 0.64, 1); }
        .star-btn:hover { transform: scale(1.4) rotate(12deg); }
        
        .glass-panel {
            background: rgba(30, 41, 59, 0.6);
            backdrop-filter: blur(16px);
            -webkit-backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.05);
        }
    </style>
</head>
<body class="min-h-screen flex flex-col bg-[#0f172a] overflow-x-hidden selection:bg-orange-500/30">

    <!-- Navbar -->
    <header class="bg-slate-900/80 backdrop-blur-xl border-b border-white/5 sticky top-0 z-50">
        <div class="container mx-auto px-4 py-3">
            <div class="flex flex-col md:flex-row justify-between items-center gap-4">
                <!-- LOGO: Ahora recarga la pÃ¡gina -->
                <div class="flex items-center gap-3 cursor-pointer group" onclick="location.reload()">
                    <div class="bg-gradient-to-br from-orange-500 to-red-600 p-2 rounded-lg shadow-lg shadow-orange-500/20 group-hover:scale-105 transition duration-300">
                        <i class="fa-solid fa-cat text-2xl text-white"></i>
                    </div>
                    <h1 class="text-xl font-bold tracking-tight text-slate-100 group-hover:text-white transition">Scratch <span class="text-orange-500">Rate</span></h1>
                </div>
                
                <!-- Search -->
                <div id="search-container" class="flex-grow max-w-lg w-full relative group">
                    <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                        <i class="fa-solid fa-magnifying-glass text-slate-500 group-focus-within:text-orange-500 transition"></i>
                    </div>
                    <form onsubmit="handleSearch(event)">
                        <input type="text" id="search-input" placeholder="Search projects..." 
                            class="w-full bg-slate-800/50 border border-slate-700/50 rounded-xl pl-10 pr-4 py-2.5 text-slate-200 placeholder-slate-500 focus:outline-none focus:ring-2 focus:ring-orange-500/50 focus:border-orange-500/50 transition shadow-sm focus:bg-slate-800">
                    </form>
                </div>
                
                <!-- Actions -->
                <div class="flex items-center gap-3 min-w-fit">
                    <button onclick="surpriseMe()" class="bg-slate-800 hover:bg-slate-700 text-slate-300 hover:text-white p-2.5 rounded-xl transition border border-white/5 group relative" title="Surprise Me!">
                        <i class="fa-solid fa-dice text-lg group-hover:rotate-180 transition duration-500"></i>
                    </button>

                    <div id="auth-section">
                        <button id="btn-login" onclick="loginWithWorker()" class="bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-semibold py-2 px-5 rounded-xl transition shadow-lg shadow-orange-900/20 flex items-center gap-2 text-sm active:scale-95">
                            <i class="fa-solid fa-right-to-bracket"></i> Login
                        </button>
                        <div id="user-info" class="hidden flex items-center gap-4 bg-slate-800/50 px-4 py-1.5 rounded-full border border-white/5 hover:bg-slate-800 transition">
                            <div class="flex items-center gap-2">
                                <div class="w-6 h-6 rounded-full bg-gradient-to-tr from-orange-400 to-purple-500 flex items-center justify-center text-[10px] font-bold text-white">
                                    <i class="fa-solid fa-user"></i>
                                </div>
                                <span id="username-display" class="font-bold text-slate-200 text-sm">User</span>
                            </div>
                            <div class="w-px h-4 bg-slate-700"></div>
                            <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300 font-medium hover:underline">Logout</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN -->
    <main class="flex-grow relative">
        
        <!-- 1. HOME VIEW -->
        <div id="home-view" class="view-section active container mx-auto px-4 py-8">
            
            <!-- CREATORS SECTION -->
            <div id="creators-section" class="mb-10 hidden">
                <h2 class="text-slate-400 text-xs font-bold uppercase tracking-wider mb-4 flex items-center gap-2">
                    <i class="fa-solid fa-crown text-yellow-500"></i> Global Top Creators
                </h2>
                <div class="flex gap-4 overflow-x-auto pb-4 custom-scrollbar" id="creators-list">
                    <!-- Creator cards injected here -->
                    <div class="flex items-center justify-center w-full py-4 text-slate-500 text-sm italic">
                        <div class="loader w-6 h-6 border-2 mr-2"></div> Loading global rankings...
                    </div>
                </div>
            </div>

            <!-- Filter Pills -->
            <div class="mb-8 flex flex-wrap gap-3 items-center">
                <span class="text-slate-500 text-xs font-bold uppercase tracking-wider mr-2"><i class="fa-solid fa-filter mr-1"></i> Filter</span>
                <button onclick="sortGrid('default')" class="sort-btn px-4 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-sm text-slate-300 border border-slate-700 transition active-sort hover:shadow-lg" id="sort-default">Trending ðŸ”¥</button>
                <button onclick="sortGrid('best')" class="sort-btn px-4 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-sm text-green-400 border border-slate-700 transition hover:border-green-500/30" id="sort-best">Top Rated ðŸ’Ž</button>
                <button onclick="sortGrid('worst')" class="sort-btn px-4 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-sm text-red-400 border border-slate-700 transition hover:border-red-500/30" id="sort-worst">Lowest Rated</button>
                <button onclick="sortGrid('most-voted')" class="sort-btn px-4 py-1.5 rounded-full bg-slate-800 hover:bg-slate-700 text-sm text-blue-400 border border-slate-700 transition hover:border-blue-500/30" id="sort-most-voted">Most Active ðŸ’¬</button>
            </div>

            <div id="loading" class="flex flex-col items-center justify-center py-32">
                <div class="loader mb-6 shadow-[0_0_20px_rgba(249,115,22,0.5)]"></div>
                <p class="text-slate-400 font-medium animate-pulse">Curating the best of Scratch...</p>
            </div>
            
            <div id="projects-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 hidden"></div>
            
            <div id="no-results" class="hidden flex flex-col items-center justify-center py-20 text-slate-500">
                <div class="bg-slate-800/50 p-6 rounded-full mb-4">
                    <i class="fa-regular fa-folder-open text-4xl opacity-50"></i>
                </div>
                <p class="text-lg font-medium">No projects found.</p>
                <button onclick="fetchProjects()" class="mt-4 text-orange-400 hover:text-orange-300 underline">Refresh Trending</button>
            </div>
        </div>

        <!-- 2. PROJECT VIEW -->
        <div id="project-view" class="view-section relative min-h-screen pb-20">
            <div id="project-background" class="absolute inset-0 bg-cover bg-center opacity-30 blur-[100px] pointer-events-none transition-all duration-1000 z-0 scale-110"></div>
            <div class="absolute inset-0 bg-gradient-to-b from-[#0f172a]/90 via-[#0f172a]/95 to-[#0f172a] pointer-events-none z-0"></div>
            
            <div class="relative container mx-auto px-4 py-6 z-10">
                <button onclick="navigateHome()" class="group mb-6 flex items-center gap-2 text-slate-400 hover:text-white transition w-fit px-4 py-2 rounded-full hover:bg-white/5 border border-transparent hover:border-white/10 backdrop-blur-sm">
                    <i class="fa-solid fa-arrow-left group-hover:-translate-x-1 transition-transform"></i>
                    <span class="font-medium">Back</span>
                </button>

                <div class="grid grid-cols-1 lg:grid-cols-12 gap-8 items-start">
                    <!-- Left Content -->
                    <div class="lg:col-span-8 flex flex-col gap-8">
                        <div class="relative group">
                            <div class="absolute -inset-1 bg-gradient-to-r from-orange-600 via-pink-600 to-purple-600 rounded-2xl blur opacity-20 group-hover:opacity-50 transition duration-1000"></div>
                            <div class="relative w-full aspect-video bg-black rounded-xl overflow-hidden shadow-2xl border border-slate-700/50">
                                <iframe id="page-iframe" class="w-full h-full" src="" allowtransparency="true" allowfullscreen allow="autoplay; microphone; camera"></iframe>
                            </div>
                        </div>

                        <div class="glass-panel p-6 sm:p-8 rounded-2xl shadow-xl">
                            <div class="flex flex-col sm:flex-row justify-between items-start gap-4 mb-6">
                                <div>
                                    <h1 id="page-title" class="text-3xl sm:text-4xl font-extrabold text-white tracking-tight mb-2 leading-tight">...</h1>
                                    <div class="flex flex-wrap items-center gap-3">
                                        <div class="flex items-center gap-2 bg-slate-800/80 px-3 py-1 rounded-full border border-slate-700">
                                            <i class="fa-solid fa-user-astronaut text-orange-400 text-xs"></i>
                                            <span id="page-author" class="text-sm font-semibold text-slate-200">...</span>
                                        </div>
                                        <span class="text-xs font-mono text-slate-500 bg-slate-900/50 px-2 py-1 rounded border border-white/5" id="page-id">ID: 000</span>
                                    </div>
                                </div>
                                <div class="flex gap-3">
                                    <div class="flex flex-col items-center bg-slate-800/50 px-4 py-2 rounded-lg border border-white/5 min-w-[70px]">
                                        <i class="fa-solid fa-eye text-blue-400 text-sm mb-1"></i>
                                        <span id="page-views" class="font-bold text-white text-sm">0</span>
                                    </div>
                                    <div class="flex flex-col items-center bg-slate-800/50 px-4 py-2 rounded-lg border border-white/5 min-w-[70px]">
                                        <i class="fa-solid fa-heart text-pink-500 text-sm mb-1"></i>
                                        <span id="page-loves" class="font-bold text-white text-sm">0</span>
                                    </div>
                                </div>
                            </div>
                            <hr class="border-white/5 my-6">
                            <div class="prose prose-invert max-w-none">
                                <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-3"><i class="fa-solid fa-align-left text-orange-500 mr-2"></i> About</h3>
                                <div class="bg-slate-900/40 p-5 rounded-xl border border-white/5"><p id="page-desc" class="text-sm text-slate-300 whitespace-pre-wrap leading-relaxed font-light">...</p></div>
                            </div>
                        </div>

                        <div class="glass-panel p-6 sm:p-8 rounded-2xl shadow-xl">
                            <h3 class="text-xl font-bold text-white mb-6 flex items-center gap-3">
                                <span class="bg-green-500/10 text-green-400 p-2 rounded-lg"><i class="fa-solid fa-comments"></i></span> Reviews
                            </h3>
                            <div id="reviews-list" class="flex flex-col gap-4"></div>
                        </div>
                    </div>

                    <!-- Right Sidebar -->
                    <div class="lg:col-span-4 flex flex-col gap-6 sticky top-24">
                        <div class="glass-panel p-6 rounded-2xl shadow-2xl relative overflow-hidden group border-t-4 border-t-orange-500">
                            <div class="absolute -top-12 -right-12 w-48 h-48 bg-orange-500/10 rounded-full blur-3xl group-hover:bg-orange-500/20 transition duration-1000"></div>
                            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-6 relative z-10 text-center">Score</h3>
                            <div class="flex flex-col items-center relative z-10">
                                <div class="relative w-48 h-48 flex items-center justify-center mb-4">
                                    <svg class="transform -rotate-90 w-48 h-48 drop-shadow-2xl"><circle cx="96" cy="96" r="80" stroke="#1e293b" stroke-width="16" fill="transparent" /><circle id="page-circle" cx="96" cy="96" r="80" stroke="#facc15" stroke-width="16" fill="transparent" stroke-dasharray="502" stroke-dashoffset="502" stroke-linecap="round" class="transition-all duration-1000 ease-out" /></svg>
                                    <div class="absolute flex flex-col items-center">
                                        <span id="page-rating-text" class="text-5xl font-black text-white tracking-tighter">?</span>
                                        <span class="text-xs font-bold text-slate-500 uppercase mt-1">/ 10</span>
                                    </div>
                                </div>
                                <div class="text-center w-full">
                                    <div class="text-lg text-white font-bold mb-2"><span id="page-score-display" class="text-slate-200">--</span></div>
                                    <div class="text-xs text-slate-400 bg-slate-900/80 px-4 py-1.5 rounded-full border border-white/10 inline-flex items-center gap-2"><i class="fa-solid fa-users"></i> <span id="page-vote-count" class="font-bold text-white">0</span> votes</div>
                                </div>
                            </div>
                        </div>

                        <div class="glass-panel p-6 rounded-2xl shadow-xl border border-white/10">
                            <h3 id="action-panel-title" class="text-xs font-bold text-slate-400 uppercase tracking-widest mb-4 flex items-center gap-2"><i class="fa-solid fa-pen-nib text-orange-500"></i> Write a Review</h3>
                            
                            <!-- Vote & Review Area -->
                            <div id="vote-area" class="transition-opacity duration-300">
                                <div class="flex justify-between mb-2 text-[10px] uppercase font-bold text-slate-500 px-1"><span>Bad</span><span>Epic</span></div>
                                <div class="grid grid-cols-10 gap-1 mb-6 bg-slate-900/50 p-2 rounded-xl border border-white/5" id="stars-container"></div>
                                <p id="vote-msg" class="text-center text-xs font-bold text-orange-400 h-4 mb-4"></p>
                                <div class="relative group">
                                    <textarea id="review-comment" maxlength="500" class="w-full bg-slate-900/80 border border-slate-700/50 rounded-xl p-4 text-sm text-white placeholder-slate-500 focus:border-orange-500 focus:ring-1 focus:ring-orange-500 focus:outline-none transition mb-3 resize-y min-h-[100px]" placeholder="Review (Optional)"></textarea>
                                    <span id="char-count" class="absolute bottom-5 right-3 text-[10px] text-slate-600">0/500</span>
                                </div>
                                <button onclick="submitReview()" id="submit-btn" class="w-full bg-gradient-to-r from-orange-600 to-red-600 hover:from-orange-500 hover:to-red-500 text-white font-bold py-3 rounded-xl transition shadow-lg shadow-orange-900/20 active:scale-95 disabled:opacity-50 disabled:cursor-not-allowed">Post Review</button>
                            </div>

                            <!-- Owner Panel (New) -->
                            <div id="owner-panel" class="hidden text-center py-2">
                                <div class="bg-gradient-to-br from-purple-500 to-indigo-600 w-14 h-14 rounded-full flex items-center justify-center mx-auto mb-3 text-white shadow-lg shadow-purple-500/30">
                                    <i class="fa-solid fa-bullhorn text-xl"></i>
                                </div>
                                <h4 class="text-white font-bold mb-1">It's your project!</h4>
                                <p class="text-slate-400 text-xs mb-4 leading-relaxed">You can't rate your own work, but you can share this link to get ratings!</p>
                                
                                <div class="bg-slate-900/50 border border-white/10 rounded-lg p-1 flex items-center gap-2 mb-2">
                                    <input id="share-link" type="text" readonly class="bg-transparent text-xs text-slate-300 w-full px-2 py-1.5 focus:outline-none font-mono" onclick="this.select()">
                                    <button onclick="copyLink()" class="bg-slate-700 hover:bg-slate-600 text-white px-3 py-1.5 rounded-md text-xs font-bold transition">Copy</button>
                                </div>
                                <p id="copy-toast" class="text-[10px] text-green-400 font-bold h-4 opacity-0 transition-opacity">Link copied to clipboard!</p>
                            </div>

                            <!-- Login Wall -->
                            <div id="login-warning" class="bg-slate-900/80 p-6 rounded-xl text-center border border-white/10 mt-2 backdrop-blur-sm">
                                <div class="bg-orange-500/10 w-12 h-12 rounded-full flex items-center justify-center mx-auto mb-3 text-white"><i class="fa-solid fa-lock text-xl"></i></div>
                                <p class="text-slate-300 text-sm mb-3">Login to rate</p>
                                <button onclick="loginWithWorker()" class="w-full text-xs bg-slate-800 hover:bg-slate-700 text-white px-4 py-2.5 rounded-lg border border-slate-600 transition font-bold">Login via Scratch</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <script>
        const WORKER_URL = "https://scratchrate.logise1123.workers.dev"; // UPDATE THIS
        const PROXY = "https://api.allorigins.win/raw?url=";
        const API_TRENDING = "https://api.scratch.mit.edu/explore/projects?limit=40&mode=trending&q=*";
        const API_SEARCH_BASE = "https://api.scratch.mit.edu/explore/projects?limit=40&mode=popular&q=";
        const PROMPTS = ["Best feature?", "Found a bug?", "Art style?", "Gameplay loop?", "Improvement ideas?"];

        let currentProject = null, sessionToken = null, currentUser = null;
        let projectsData = [], projectsStatsCache = {}, currentRating = 0;

        window.addEventListener('DOMContentLoaded', () => {
            generateStarsUI();
            checkAuth();
            handleRouting();
            if(!location.hash.startsWith('#project-')) fetchProjects();
            
            document.getElementById('review-comment').addEventListener('input', (e) => {
                document.getElementById('char-count').textContent = `${e.target.value.length}/500`;
            });
            document.getElementById('review-comment').placeholder = PROMPTS[Math.floor(Math.random()*PROMPTS.length)];
        });

        window.addEventListener('hashchange', handleRouting);

        function handleRouting() {
            const hash = location.hash;
            if (hash.startsWith('#project-')) showProjectPage(hash.replace('#project-', ''));
            else showHomePage();
        }

        function navigateHome() { window.location.hash = ""; }

        function showHomePage() {
            document.getElementById('home-view').classList.add('active');
            document.getElementById('project-view').classList.remove('active');
            document.getElementById('search-container').classList.remove('hidden');
            document.getElementById('page-iframe').src = "";
            document.body.style.overflow = "auto";
            if(projectsData.length === 0) fetchProjects();
            
            // Trigger load of top creators
            fetchTopCreators();
        }

        async function showProjectPage(id) {
            document.getElementById('home-view').classList.remove('active');
            document.getElementById('project-view').classList.add('active');
            document.getElementById('search-container').classList.add('hidden');
            window.scrollTo(0,0);

            let p = projectsData.find(x => x.id == id);
            if (!p) {
                try {
                    const res = await fetch(`${WORKER_URL}/proxy?url=${encodeURIComponent(`https://api.scratch.mit.edu/projects/${id}`)}`);
                    if(!res.ok) throw new Error("Not found");
                    p = await res.json();
                    if(!p.author) p.author = { username: p.username || "Unknown" };
                } catch(e) { alert("Project not found."); navigateHome(); return; }
            }
            currentProject = p;
            renderProjectDetails(p);
        }

        function renderProjectDetails(p) {
            const thumbUrl = `https://cdn2.scratch.mit.edu/get_image/project/${p.id}_480x360.png`;
            document.getElementById('project-background').style.backgroundImage = `url('${thumbUrl}')`;
            document.getElementById('page-title').textContent = p.title;
            document.getElementById('page-author').textContent = p.author.username;
            document.getElementById('page-id').textContent = `ID: ${p.id}`;
            document.getElementById('page-desc').textContent = (p.instructions||"") + "\n\n" + (p.description||"");
            document.getElementById('page-iframe').src = `https://scratch.mit.edu/projects/${p.id}/embed`;
            document.getElementById('page-views').textContent = formatNum(p.stats.views);
            document.getElementById('page-loves').textContent = formatNum(p.stats.loves);

            updatePageRating(0, 0, true);
            resetStars();
            document.getElementById('reviews-list').innerHTML = '<div class="flex justify-center py-8"><div class="loader"></div></div>';
            
            // Check if current user is owner
            updateActionPanelUI();

            fetchProjectStatsAndReviews(p.id);
        }

        function updateActionPanelUI() {
            const isOwner = currentUser && currentProject && currentUser.toLowerCase() === currentProject.author.username.toLowerCase();
            const voteArea = document.getElementById('vote-area');
            const loginWarning = document.getElementById('login-warning');
            const ownerPanel = document.getElementById('owner-panel');
            const panelTitle = document.getElementById('action-panel-title');

            // Hide everything first
            voteArea.classList.add('hidden');
            loginWarning.classList.add('hidden');
            ownerPanel.classList.add('hidden');

            if (sessionToken) {
                if (isOwner) {
                    ownerPanel.classList.remove('hidden');
                    panelTitle.textContent = "Promote Your Project";
                    document.getElementById('share-link').value = window.location.href;
                } else {
                    voteArea.classList.remove('hidden');
                    voteArea.classList.remove('opacity-50', 'pointer-events-none');
                    panelTitle.innerHTML = `<i class="fa-solid fa-pen-nib text-orange-500"></i> Write a Review`;
                }
            } else {
                // Not logged in
                voteArea.classList.remove('hidden');
                voteArea.classList.add('opacity-50', 'pointer-events-none');
                loginWarning.classList.remove('hidden');
                panelTitle.innerHTML = `<i class="fa-solid fa-pen-nib text-orange-500"></i> Write a Review`;
            }
        }

        function copyLink() {
            const input = document.getElementById('share-link');
            input.select();
            input.setSelectionRange(0, 99999);
            navigator.clipboard.writeText(input.value).then(() => {
                const toast = document.getElementById('copy-toast');
                toast.classList.remove('opacity-0');
                setTimeout(() => toast.classList.add('opacity-0'), 2000);
            });
        }

        async function fetchProjectStatsAndReviews(id) {
            try {
                const res = await fetch(`${WORKER_URL}/stats?id=${id}`);
                const data = await res.json();
                projectsStatsCache[id] = data;
                updatePageRating(Number(data.average), Number(data.count));
                renderReviews(data.reviews || []);
            } catch(e) { document.getElementById('reviews-list').innerHTML = '<p class="text-red-400 text-center">Failed to load reviews.</p>'; }
        }

        function renderReviews(reviews) {
            const list = document.getElementById('reviews-list');
            list.innerHTML = '';
            if (reviews.length === 0) { list.innerHTML = `<div class="text-center py-10 opacity-50"><i class="fa-regular fa-comments text-4xl mb-2"></i><p>No reviews yet.</p></div>`; return; }
            reviews.forEach(r => {
                let colorClass = r.rating >= 8 ? 'text-green-400 border-green-500/30' : (r.rating >= 5 ? 'text-yellow-400 border-yellow-500/30' : 'text-red-400 border-red-500/30');
                list.innerHTML += `<div class="bg-slate-900/40 p-4 rounded-xl border border-white/5 flex flex-col gap-2 hover:bg-slate-900/60">
                    <div class="flex justify-between items-center"><div class="flex items-center gap-3"><div class="w-8 h-8 rounded-full bg-slate-800 flex items-center justify-center font-bold border border-white/5">${escapeHtml(r.username).charAt(0).toUpperCase()}</div><div><div class="font-bold text-sm text-white">${escapeHtml(r.username)}</div><div class="text-[10px] text-slate-500">${new Date(r.timestamp).toLocaleDateString()}</div></div></div><div class="${colorClass} px-2.5 py-1 rounded-lg text-xs font-bold border flex items-center gap-1.5 bg-slate-900"><i class="fa-solid fa-star text-[10px]"></i> ${r.rating}</div></div>${r.comment ? `<p class="text-slate-300 text-sm mt-1 pl-11">${escapeHtml(r.comment)}</p>` : ''}</div>`;
            });
        }

        function updatePageRating(avg, count, reset=false) {
            const circle = document.getElementById('page-circle');
            const display = document.getElementById('page-score-display');
            const ratingTxt = document.getElementById('page-rating-text');
            document.getElementById('page-vote-count').textContent = count;
            if(reset) { circle.style.strokeDashoffset = 502; display.textContent = "--"; ratingTxt.textContent = "?"; return; }
            display.textContent = avg.toFixed(1);
            ratingTxt.textContent = avg.toFixed(1);
            circle.style.strokeDashoffset = 502 - (502 * (avg/10 * 100)) / 100;
            if(avg>=8) circle.setAttribute('stroke', '#4ade80'); else if(avg>=5) circle.setAttribute('stroke', '#facc15'); else circle.setAttribute('stroke', '#f87171');
        }

        // --- STARS & VOTING ---
        function generateStarsUI() {
            const c = document.getElementById('stars-container');
            c.innerHTML = '';
            for(let i=1; i<=10; i++) {
                const b = document.createElement('i');
                b.className = `star-btn fa-solid fa-star text-slate-700 text-lg flex justify-center py-1`;
                b.id = `s${i}`;
                b.onclick = () => { currentRating = i; highlightStars(i); document.getElementById('vote-msg').textContent = `${i}/10`; };
                b.onmouseover = () => { highlightStars(i); document.getElementById('vote-msg').textContent = `${i}/10`; };
                b.onmouseout = () => { if(currentRating===0) resetStars(); else highlightStars(currentRating); };
                c.appendChild(b);
            }
        }
        function highlightStars(n) {
            for(let j=1; j<=10; j++) {
                const s = document.getElementById(`s${j}`);
                s.classList.remove('text-slate-700','text-yellow-400','text-green-400','text-red-400');
                if(j<=n) { if(n<=4) s.classList.add('text-red-400'); else if(n<=7) s.classList.add('text-yellow-400'); else s.classList.add('text-green-400'); } else s.classList.add('text-slate-700');
            }
        }
        function resetStars() { document.getElementById('vote-msg').textContent="Select rating"; for(let j=1; j<=10; j++) document.getElementById(`s${j}`).className=`star-btn fa-solid fa-star text-slate-700 text-lg flex justify-center py-1`; }

        async function submitReview() {
            if (!sessionToken) return alert("Login required");
            if (currentRating === 0) return alert("Rate first!");
            const comment = document.getElementById('review-comment').value.trim();
            const btn = document.getElementById('submit-btn');
            btn.disabled = true; btn.innerText = "Posting...";
            
            try {
                const res = await fetch(`${WORKER_URL}/vote`, { method: 'POST', headers: {'Content-Type':'application/json'}, body: JSON.stringify({ sessionToken, projectId: currentProject.id, projectAuthor: currentProject.author.username, rating: currentRating, comment }) });
                if(res.ok) {
                    confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 }, colors: ['#f97316', '#22c55e'] });
                    fetchProjectStatsAndReviews(currentProject.id); fetchCardStats(currentProject.id);
                    document.getElementById('review-comment').value = "";
                    btn.innerHTML = `<i class="fa-solid fa-check"></i> Posted!`;
                    setTimeout(() => { btn.disabled = false; btn.textContent = "Post Review"; }, 2000);
                } else throw new Error("Failed");
            } catch(e) { alert("Error"); btn.disabled = false; btn.textContent = "Post Review"; }
        }

        // --- DATA FETCHING & UI ---
        async function fetchWithProxy(url) {
            const res = await fetch(`${WORKER_URL}/proxy?url=${encodeURIComponent(url)}`);
            if(!res.ok) throw new Error("Proxy error");
            return res.json();
        }
        function handleSearch(e) { e.preventDefault(); const q=document.getElementById('search-input').value.trim(); if(q){ navigateHome(); toggleLoading(true); fetchProjects(API_SEARCH_BASE+encodeURIComponent(q)); } }
        async function fetchProjects(url=API_TRENDING) {
            try {
                const data = await fetchWithProxy(url);
                if(!data||data.length===0) { toggleLoading(false,true); projectsData=[]; return; }
                projectsData = data;
                fetchBatchStats(data.map(p=>p.id));
                // renderTopCreators(); // Removed here, called in showHomePage or separately
                renderGrid(projectsData);
                toggleLoading(false);
            } catch(e) { document.getElementById('loading').innerHTML = "<p class='text-red-400'>Error loading data.</p>"; }
        }
        async function fetchBatchStats(ids) {
            try {
                const res = await fetch(`${WORKER_URL}/stats-batch`, {method:'POST', body:JSON.stringify({ids})});
                if(res.ok) { Object.assign(projectsStatsCache, await res.json()); renderGrid(projectsData); }
            } catch(e){}
        }
        async function fetchCardStats(id) { try { const r=await fetch(`${WORKER_URL}/stats?id=${id}`); projectsStatsCache[id]=await r.json(); } catch(e){} }

        function renderGrid(projects) {
            const g = document.getElementById('projects-grid'); g.innerHTML = '';
            projects.forEach(p => {
                const stats = projectsStatsCache[p.id] || {count:0,average:0};
                let badge = stats.count>=5 ? `<div class="absolute top-2 left-2 ${stats.average>=8?'bg-green-500':'bg-yellow-500'} text-white px-2 py-0.5 rounded-md text-[10px] font-bold shadow-lg flex items-center gap-1"><i class="fa-solid fa-star text-[8px]"></i> ${Number(stats.average).toFixed(1)}</div>` : `<div class="absolute top-2 left-2 bg-slate-900/90 text-gray-400 px-2 py-0.5 rounded-md text-[10px] font-bold border border-slate-600"><i class="fa-regular fa-clock"></i> Pending</div>`;
                g.innerHTML += `<div class="project-card bg-slate-800 rounded-xl overflow-hidden border border-slate-700 relative flex flex-col h-full" onclick="window.location.hash='project-${p.id}'"><div class="relative w-full aspect-[4/3] bg-black"><img src="https://cdn2.scratch.mit.edu/get_image/project/${p.id}_480x360.png" class="w-full h-full object-cover" loading="lazy"><div class="absolute bottom-2 right-2 bg-black/60 px-2 py-0.5 rounded text-[10px] text-white backdrop-blur-sm"><i class="fa-solid fa-eye"></i> ${formatNum(p.stats.views)}</div>${badge}</div><div class="p-4"><h3 class="font-bold text-slate-100 truncate text-sm mb-1">${escapeHtml(p.title)}</h3><p class="text-xs text-slate-400">by <span class="text-orange-400">${escapeHtml(p.author.username)}</span></p></div></div>`;
            });
        }

        // --- NEW: TOP CREATORS (Backend Fetch) ---
        async function fetchTopCreators() {
            try {
                const res = await fetch(`${WORKER_URL}/top-creators`);
                if (!res.ok) throw new Error("API Error");
                const creators = await res.json();
                renderTopCreators(creators);
            } catch(e) {
                console.error("Top creators fetch failed:", e);
                document.getElementById('creators-section').classList.add('hidden');
            }
        }

        function renderTopCreators(sortedCreators) {
            const list = document.getElementById('creators-list');
            const section = document.getElementById('creators-section');
            
            if (!sortedCreators || sortedCreators.length === 0) { section.classList.add('hidden'); return; }
            section.classList.remove('hidden');
            list.innerHTML = '';

            sortedCreators.forEach((c, index) => {
                const score = Number(c.score).toFixed(1);
                // Try to find image in loaded projects, else fetch
                let imgId = null;
                // Simple optimization: look in current projects
                const p = projectsData.find(proj => proj.author.username === c.username);
                if (p) imgId = p.author.id;

                const imgUrl = imgId ? `https://cdn2.scratch.mit.edu/get_image/user/${imgId}_60x60.png` : `https://cdn2.scratch.mit.edu/get_image/user/default_60x60.png`;

                const card = document.createElement('div');
                card.className = "creator-card min-w-[120px] bg-slate-800 p-3 rounded-xl border border-slate-700 flex flex-col items-center gap-2 cursor-pointer relative";
                card.onclick = () => window.open(`https://scratch.mit.edu/users/${escapeHtml(c.username)}`, '_blank');
                card.innerHTML = `
                    <div class="absolute top-1 left-1 text-[10px] font-bold text-slate-500">#${index+1}</div>
                    <img src="${imgUrl}" class="w-12 h-12 rounded-full border-2 border-slate-600 bg-slate-700" id="img-${index}">
                    <div class="text-center">
                        <div class="font-bold text-slate-200 text-xs truncate max-w-[100px]">${escapeHtml(c.username)}</div>
                        <div class="text-[10px] text-green-400 font-bold">Score: ${score}</div>
                    </div>`;
                list.appendChild(card);

                // If we didn't have the ID, fetch it asynchronously
                if (!imgId) {
                    fetchWithProxy(`https://api.scratch.mit.edu/users/${c.username}`)
                        .then(u => {
                            if(u && u.id) {
                                document.getElementById(`img-${index}`).src = `https://cdn2.scratch.mit.edu/get_image/user/${u.id}_60x60.png`;
                            }
                        }).catch(()=>{});
                }
            });
        }

        function sortGrid(mode) {
            document.querySelectorAll('.sort-btn').forEach(b=>{ b.classList.remove('bg-slate-700','border-slate-500','text-white','shadow-lg'); b.classList.add('bg-slate-800','text-slate-300','border-slate-700'); });
            document.getElementById(`sort-${mode}`).classList.replace('bg-slate-800','bg-slate-700');
            let s=[...projectsData];
            if(mode!=='default'){ s=s.filter(p=>(projectsStatsCache[p.id]?.count||0)>0); if(mode==='best')s.sort((a,b)=>(projectsStatsCache[b.id]?.average||0)-(projectsStatsCache[a.id]?.average||0)); else if(mode==='worst')s.sort((a,b)=>(projectsStatsCache[a.id]?.average||0)-(projectsStatsCache[b.id]?.average||0)); else if(mode==='most-voted')s.sort((a,b)=>(projectsStatsCache[b.id]?.count||0)-(projectsStatsCache[a.id]?.count||0)); }
            renderGrid(s);
        }

        function toggleLoading(s,e=false) { const l=document.getElementById('loading'),g=document.getElementById('projects-grid'),n=document.getElementById('no-results'); if(s){l.classList.remove('hidden');g.classList.add('hidden');n.classList.add('hidden');}else{l.classList.add('hidden');g.classList.toggle('hidden',e);n.classList.toggle('hidden',!e);} }
        function surpriseMe() { if(projectsData.length){ window.location.hash=`project-${projectsData[Math.floor(Math.random()*projectsData.length)].id}`; } }
        function checkAuth() { const p=new URLSearchParams(location.search); if(p.get('token')){localStorage.setItem('s_tok',p.get('token'));localStorage.setItem('s_usr',p.get('username'));history.replaceState({},'','/');} sessionToken=localStorage.getItem('s_tok'); currentUser=localStorage.getItem('s_usr'); if(sessionToken){document.getElementById('btn-login').classList.add('hidden');document.getElementById('user-info').classList.remove('hidden');document.getElementById('username-display').textContent=currentUser;document.getElementById('vote-area').classList.remove('opacity-50','pointer-events-none');document.getElementById('login-warning').classList.add('hidden');} }
        function loginWithWorker() { location.href=`${WORKER_URL}/auth/login`; }
        function logout() { localStorage.clear(); location.reload(); }
        function formatNum(n) { return new Intl.NumberFormat('en-US',{notation:"compact"}).format(n); }
        function escapeHtml(t) { return t?t.replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;"):"" }
    </script>
</body>
</html>
