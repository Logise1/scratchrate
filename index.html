<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Scratch Trending Explorer</title>
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- FontAwesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, setDoc, query, where, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase Configuration (Environment Aware)
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app';

        let db, auth, user;

        if (firebaseConfig) {
            const app = initializeApp(firebaseConfig);
            auth = getAuth(app);
            db = getFirestore(app);
            
            // Auto-login to Firebase for database access
            signInAnonymously(auth).then((u) => {
                user = u.user;
                console.log("Connected to Database");
            }).catch(console.error);
        }

        // Expose functions to window for HTML access
        window.rateProject = async (stars) => {
            if (!db || !auth.currentUser) return alert("Database not connected.");
            
            // We use a simulated 'Scratch Username' for the vote ID, but Firebase Auth for security
            const scratchUser = localStorage.getItem('scratch_user');
            if (!scratchUser) return alert("Please login with Scratch first to vote.");
            
            const currentProjectId = window.currentProjectId; // Set by modal
            if(!currentProjectId) return;

            // Save vote to Firestore
            // Path: artifacts/{appId}/public/data/votes
            // DocID: {projectId}_{scratchUser} (One vote per user per project)
            const voteRef = doc(db, 'artifacts', appId, 'public', 'data', 'votes', `${currentProjectId}_${scratchUser}`);
            
            // Optimistic UI Update
            updateStarsUI(stars);

            try {
                await setDoc(voteRef, {
                    projectId: String(currentProjectId),
                    username: scratchUser,
                    rating: stars,
                    timestamp: Date.now()
                });
                
                // Show feedback
                const msg = document.getElementById('vote-msg');
                msg.textContent = `Saved: ${stars} Stars!`;
                msg.className = "text-center text-xs text-green-400 mt-2";
                setTimeout(() => msg.textContent = "", 2000);
            } catch (e) {
                console.error("Error saving vote:", e);
                alert("Failed to save vote.");
            }
        };

        window.listenToVotes = (projectId) => {
            if (!db) return;
            
            // Query votes for this project
            const q = query(
                collection(db, 'artifacts', appId, 'public', 'data', 'votes'),
                where("projectId", "==", String(projectId))
            );

            // Real-time listener
            return onSnapshot(q, (snapshot) => {
                let totalStars = 0;
                let count = 0;
                
                snapshot.forEach(doc => {
                    const data = doc.data();
                    totalStars += data.rating;
                    count++;
                });

                updateRatingDisplay(totalStars, count);
            });
        };
    </script>
    
    <style>
        body { background-color: #0f172a; color: #e2e8f0; font-family: 'Segoe UI', sans-serif; }
        .project-card { transition: transform 0.2s, box-shadow 0.2s; cursor: pointer; }
        .project-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(249, 115, 22, 0.3); border-color: #f97316; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1e293b; }
        ::-webkit-scrollbar-thumb { background: #f97316; border-radius: 4px; }
        .scratch-text { color: #f97316; }
        .loader { border: 4px solid #1e293b; border-top: 4px solid #f97316; border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .star-btn { cursor: pointer; transition: color 0.2s; }
        .star-btn:hover, .star-btn.active { color: #facc15; }
    </style>
</head>
<body class="min-h-screen flex flex-col">

    <!-- Header -->
    <header class="bg-slate-800 border-b border-slate-700 sticky top-0 z-40 shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <i class="fa-solid fa-cat text-3xl scratch-text"></i>
                <h1 class="text-2xl font-bold tracking-tight hidden sm:block">Scratch <span class="scratch-text">Trending</span></h1>
            </div>
            
            <!-- Auth Section -->
            <div id="auth-section" class="flex items-center gap-4">
                <button id="btn-login" onclick="fakeLogin()" class="bg-orange-600 hover:bg-orange-700 text-white font-bold py-2 px-4 rounded transition flex items-center gap-2">
                    <i class="fa-solid fa-right-to-bracket"></i> Login with Scratch
                </button>
                <div id="user-info" class="hidden flex items-center gap-3">
                    <span class="text-sm text-slate-300">Hi, <span id="username-display" class="font-bold text-white">User</span></span>
                    <button onclick="logout()" class="text-xs text-red-400 hover:text-red-300 underline">Logout</button>
                </div>
            </div>
        </div>
    </header>

    <!-- Main Content -->
    <main class="flex-grow container mx-auto px-4 py-8">
        <div id="loading" class="flex flex-col items-center justify-center py-20">
            <div class="loader mb-4"></div>
            <p class="text-slate-400 animate-pulse">Loading Projects...</p>
        </div>
        <div id="projects-grid" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-6 hidden"></div>
    </main>

    <!-- Modal -->
    <div id="project-modal" class="fixed inset-0 z-50 hidden flex items-center justify-center bg-black/80 p-4 backdrop-blur-sm">
        <div class="bg-slate-900 rounded-xl shadow-2xl w-full max-w-6xl max-h-[95vh] overflow-hidden flex flex-col border border-slate-700">
            <div class="flex justify-between items-center p-4 border-b border-slate-800 bg-slate-900">
                <h2 class="text-lg font-semibold text-slate-300 truncate pr-4" id="modal-title-top">Project Viewer</h2>
                <button onclick="closeModal()" class="text-slate-400 hover:text-white transition"><i class="fa-solid fa-xmark text-2xl"></i></button>
            </div>

            <div class="flex-grow overflow-y-auto p-0 lg:p-6">
                <div class="flex flex-col lg:flex-row gap-6">
                    <!-- Left: Embed -->
                    <div class="w-full lg:w-2/3 flex flex-col gap-4">
                        <div class="w-full aspect-video bg-black rounded-lg overflow-hidden shadow-lg border border-slate-800 relative">
                            <iframe id="modal-iframe" class="w-full h-full" src="" allowtransparency="true" allowfullscreen></iframe>
                        </div>
                        <div class="bg-slate-800/50 p-4 rounded-lg border border-slate-700">
                            <h1 id="modal-title" class="text-3xl font-bold text-white mb-1">...</h1>
                            <p class="text-slate-400">by <span id="modal-author" class="text-orange-400 font-bold">...</span> <span class="text-xs bg-slate-700 px-2 py-0.5 rounded ml-2" id="modal-id">ID</span></p>
                        </div>
                    </div>

                    <!-- Right: Data + Star Rating -->
                    <div class="w-full lg:w-1/3 flex flex-col gap-4">
                        <!-- Rating Box -->
                        <div class="bg-slate-800 p-5 rounded-lg border border-slate-700 shadow-lg relative overflow-hidden">
                            <div class="absolute top-0 right-0 p-2 opacity-10"><i class="fa-solid fa-star text-6xl"></i></div>
                            <h3 class="text-sm font-uppercase text-slate-400 font-bold mb-3 tracking-wider">COMMUNITY RATING</h3>
                            
                            <div class="flex items-center gap-4 mb-4">
                                <div class="relative w-20 h-20 flex items-center justify-center">
                                    <svg class="transform -rotate-90 w-20 h-20">
                                        <circle cx="40" cy="40" r="36" stroke="#334155" stroke-width="8" fill="transparent" />
                                        <circle id="enjoyment-circle" cx="40" cy="40" r="36" stroke="#fbbf24" stroke-width="8" fill="transparent" stroke-dasharray="226" stroke-dashoffset="226" />
                                    </svg>
                                    <span id="rating-text" class="absolute text-xl font-bold text-white">0.0</span>
                                </div>
                                <div>
                                    <div class="flex text-yellow-400 text-sm mb-1" id="stars-display">
                                        <i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i><i class="fa-regular fa-star"></i>
                                    </div>
                                    <div class="text-xs text-slate-500"><span id="vote-count">0</span> votes</div>
                                </div>
                            </div>
                            
                            <!-- Stats Scratch Originales -->
                            <div class="flex justify-between text-xs text-slate-500 mt-2 border-t border-slate-700 pt-2">
                                <span><i class="fa-regular fa-eye"></i> Views: <span id="stat-views">0</span></span>
                                <span><i class="fa-regular fa-heart"></i> Loves: <span id="stat-loves">0</span></span>
                            </div>
                        </div>

                        <!-- Panel VotaciÃ³n (Stars) -->
                        <div class="bg-slate-800 p-5 rounded-lg border border-slate-700">
                            <h3 class="text-sm font-uppercase text-slate-400 font-bold mb-3 tracking-wider">RATE THIS PROJECT</h3>
                            
                            <div id="vote-area" class="opacity-50 pointer-events-none transition-opacity">
                                <div class="flex justify-center gap-2 text-3xl text-slate-600 mb-2">
                                    <button onclick="window.rateProject(1)" onmouseover="hoverStars(1)" onmouseout="resetStars()" class="star-btn fa-solid fa-star" id="s1"></button>
                                    <button onclick="window.rateProject(2)" onmouseover="hoverStars(2)" onmouseout="resetStars()" class="star-btn fa-solid fa-star" id="s2"></button>
                                    <button onclick="window.rateProject(3)" onmouseover="hoverStars(3)" onmouseout="resetStars()" class="star-btn fa-solid fa-star" id="s3"></button>
                                    <button onclick="window.rateProject(4)" onmouseover="hoverStars(4)" onmouseout="resetStars()" class="star-btn fa-solid fa-star" id="s4"></button>
                                    <button onclick="window.rateProject(5)" onmouseover="hoverStars(5)" onmouseout="resetStars()" class="star-btn fa-solid fa-star" id="s5"></button>
                                </div>
                                <p id="vote-msg" class="text-center text-xs text-slate-500">Click a star to vote</p>
                            </div>
                            
                            <p id="login-warning" class="text-center text-xs text-orange-400 mt-3">Please login to rate.</p>
                        </div>

                        <div class="bg-slate-800 p-5 rounded-lg border border-slate-700 flex-grow">
                            <h3 class="text-sm font-uppercase text-slate-400 font-bold mb-2">Instructions & Notes</h3>
                            <div class="overflow-y-auto max-h-40 custom-scrollbar pr-2">
                                <p id="modal-desc" class="text-sm text-slate-300 whitespace-pre-wrap">...</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURATION ---
        const PROXY = "https://api.allorigins.win/raw?url=";
        const API_SCRATCH = "https://api.scratch.mit.edu/explore/projects?limit=32&offset=0&language=es&mode=trending&q=*";

        let currentProject = null;
        let currentUser = null;
        let voteUnsubscribe = null;

        // --- INIT ---
        window.addEventListener('DOMContentLoaded', () => {
            checkAuth();
            fetchProjects();
        });

        // --- AUTH (SIMULATED FOR USERNAME, FIREBASE FOR DB) ---
        function checkAuth() {
            currentUser = localStorage.getItem('scratch_user');
            updateAuthUI();
        }

        function updateAuthUI() {
            const btnLogin = document.getElementById('btn-login');
            const userInfo = document.getElementById('user-info');
            const voteArea = document.getElementById('vote-area');
            const loginWarn = document.getElementById('login-warning');

            if (currentUser) {
                btnLogin.classList.add('hidden');
                userInfo.classList.remove('hidden');
                document.getElementById('username-display').textContent = currentUser;
                
                // Enable Voting
                voteArea.classList.remove('opacity-50', 'pointer-events-none');
                loginWarn.classList.add('hidden');
            } else {
                btnLogin.classList.remove('hidden');
                userInfo.classList.add('hidden');
                voteArea.classList.add('opacity-50', 'pointer-events-none');
                loginWarn.classList.remove('hidden');
            }
        }

        // Simulates a login (since we can't do real OAuth redirects easily without backend in this snippet)
        function fakeLogin() {
            const username = prompt("Enter your Scratch Username to simulate login:");
            if(username) {
                localStorage.setItem('scratch_user', username);
                checkAuth();
            }
        }

        function logout() {
            localStorage.removeItem('scratch_user');
            checkAuth();
            location.reload();
        }

        // --- PROJECTS LOGIC ---
        async function fetchProjects() {
            try {
                const res = await fetch(PROXY + encodeURIComponent(API_SCRATCH));
                const data = await res.json();
                renderGrid(data);
            } catch (e) {
                console.error(e);
                document.getElementById('loading').innerHTML = "<p class='text-red-400'>Error loading Scratch API. Try refreshing.</p>";
            }
        }

        function renderGrid(projects) {
            const grid = document.getElementById('projects-grid');
            document.getElementById('loading').classList.add('hidden');
            grid.classList.remove('hidden');
            grid.innerHTML = '';

            projects.forEach(p => {
                const card = document.createElement('div');
                card.className = "project-card bg-slate-800 rounded-lg overflow-hidden border border-slate-700 relative";
                card.onclick = () => openModal(p);
                
                const img = `https://cdn2.scratch.mit.edu/get_image/project/${p.id}_480x360.png`;
                
                card.innerHTML = `
                    <div class="relative w-full aspect-[4/3] bg-black">
                        <img src="${img}" class="w-full h-full object-cover" loading="lazy">
                        <div class="absolute bottom-2 right-2 bg-black/60 px-2 rounded text-xs text-white">
                            <i class="fa-solid fa-eye"></i> ${formatNum(p.stats.views)}
                        </div>
                    </div>
                    <div class="p-3">
                        <h3 class="font-bold text-white truncate">${p.title}</h3>
                        <p class="text-xs text-slate-400">by ${p.author.username}</p>
                    </div>
                `;
                grid.appendChild(card);
            });
        }

        // --- MODAL & LOGIC ---
        function openModal(p) {
            currentProject = p;
            window.currentProjectId = p.id; // Expose for module script
            
            const modal = document.getElementById('project-modal');
            
            // UI Basic
            document.getElementById('modal-title').textContent = p.title;
            document.getElementById('modal-title-top').textContent = p.title;
            document.getElementById('modal-author').textContent = p.author.username;
            document.getElementById('modal-id').textContent = p.id;
            document.getElementById('modal-desc').textContent = (p.instructions || "") + "\n\n" + (p.description || "");
            document.getElementById('modal-iframe').src = `https://scratch.mit.edu/projects/${p.id}/embed`;
            
            // Stats Scratch
            document.getElementById('stat-views').textContent = formatNum(p.stats.views);
            document.getElementById('stat-loves').textContent = formatNum(p.stats.loves);

            // Reset Rating UI
            updateRatingDisplay(0, 0); // Reset to 0 before loading
            resetStars();

            // Connect to Firebase listener if available
            if(window.listenToVotes) {
                if(voteUnsubscribe) voteUnsubscribe(); // Stop listening to previous project
                voteUnsubscribe = window.listenToVotes(p.id);
            }

            modal.classList.remove('hidden');
        }

        // Update the circular progress and text based on average
        window.updateRatingDisplay = (totalStars, count) => {
            const average = count === 0 ? 0 : (totalStars / count).toFixed(1);
            const percentage = (average / 5) * 100;
            
            document.getElementById('rating-text').textContent = average;
            document.getElementById('vote-count').textContent = count;
            
            // Circle Progress
            const circle = document.getElementById('enjoyment-circle');
            const offset = 226 - (226 * percentage) / 100;
            circle.style.strokeDashoffset = offset;

            // Star icons display (small ones)
            const starsDisplay = document.getElementById('stars-display');
            let starsHTML = '';
            for(let i=1; i<=5; i++) {
                if (i <= Math.round(average)) starsHTML += '<i class="fa-solid fa-star"></i>';
                else starsHTML += '<i class="fa-regular fa-star"></i>';
            }
            starsDisplay.innerHTML = starsHTML;
        }

        // UI Interactions for Voting
        window.hoverStars = (num) => {
            for(let i=1; i<=5; i++) {
                const s = document.getElementById(`s${i}`);
                if(i <= num) s.classList.add('text-yellow-400');
                else s.classList.remove('text-yellow-400');
            }
        }

        window.resetStars = () => {
            for(let i=1; i<=5; i++) {
                document.getElementById(`s${i}`).classList.remove('text-yellow-400');
            }
        }

        window.updateStarsUI = (votedNum) => {
             for(let i=1; i<=5; i++) {
                const s = document.getElementById(`s${i}`);
                if(i <= votedNum) s.classList.add('text-yellow-400');
                else s.classList.remove('text-yellow-400');
            }
        }

        function closeModal() {
            document.getElementById('project-modal').classList.add('hidden');
            document.getElementById('modal-iframe').src = "";
            if(voteUnsubscribe) voteUnsubscribe();
        }

        function formatNum(n) {
            return new Intl.NumberFormat('en-US', { notation: "compact" }).format(n);
        }
    </script>
</body>
</html>
